{"version":3,"file":"publish-zome.js","sourceRoot":"","sources":["../../src/elements/publish-zome.ts"],"names":[],"mappings":"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","sourcesContent":["import { css, html, LitElement } from 'lit';\nimport { property, query, state } from 'lit/decorators.js';\nimport { ScopedRegistryHost } from '@lit-labs/scoped-registry-mixin';\nimport { requestContext } from '@holochain-open-dev/context';\n\nimport { TextField } from 'scoped-material-components/mwc-textfield';\nimport { UploadFiles } from '@holochain-open-dev/file-storage';\nimport { Card } from 'scoped-material-components/mwc-card';\nimport { Button } from 'scoped-material-components/mwc-button';\nimport { Snackbar } from 'scoped-material-components/mwc-snackbar';\n\nimport { CompositoryService } from '../services/compository-service';\nimport { importModuleFromFile } from '../processes/import-module-from-file';\nimport { sharedStyles } from './sharedStyles';\nimport { SetupLenses } from '../types/lenses';\nimport { COMPOSITORY_SERVICE_CONTEXT } from '../types/context';\n\nexport class PublishZome extends ScopedRegistryHost(LitElement) {\n  @requestContext(COMPOSITORY_SERVICE_CONTEXT)\n  _compositoryService!: CompositoryService;\n\n  @query('#zome-name')\n  _nameField!: TextField;\n\n  @state()\n  _zomeWasmHash: string | undefined = undefined;\n  _uiBundleHash: string | undefined = undefined;\n  @state()\n  _invalidUiBundle = false;\n\n  get publishDisabled() {\n    return (\n      !this._zomeWasmHash ||\n      !this._nameField ||\n      !this._nameField.value ||\n      this._invalidUiBundle\n    );\n  }\n\n  async publishZome() {\n    if (this._zomeWasmHash) {\n      const result = await this._compositoryService.publishZome({\n        name: this._nameField.value,\n        components_bundle_file: this._uiBundleHash,\n        entry_defs: [],\n        wasm_file: this._zomeWasmHash,\n        wasm_hash: undefined,\n        required_membrane_proof: false,\n        required_properties: [],\n      });\n      this.dispatchEvent(\n        new CustomEvent('zome-published', {\n          detail: {\n            zomeDefHash: result,\n          },\n        })\n      );\n    }\n  }\n\n  async setUIBundleHash(file: File, hash: string) {\n    try {\n      const mod = await importModuleFromFile(file);\n      const setupLenses: SetupLenses = mod.default;\n\n      const lenses = setupLenses(\n        this._compositoryService.appWebsocket,\n        this._compositoryService.cellId\n      );\n\n      if (\n        !lenses.standalone ||\n        !lenses.entryLenses ||\n        !lenses.attachmentsLenses\n      ) {\n        throw new Error('Malformed lenses');\n      }\n\n      this._uiBundleHash = hash;\n      this._invalidUiBundle = false;\n    } catch (e) {\n      (this.shadowRoot?.getElementById('error-snackbar') as Snackbar).show();\n      this._invalidUiBundle = true;\n    }\n  }\n\n  renderErrorSnackbar() {\n    return html`\n      <mwc-snackbar id=\"error-snackbar\" labelText=\"Invalid UI bundle\">\n        <mwc-button\n          slot=\"action\"\n          label=\"See Documentation\"\n          @click=${() => window.open('https://github.com/compository/lib')}\n        ></mwc-button>\n      </mwc-snackbar>\n    `;\n  }\n  render() {\n    return html`\n      ${this.renderErrorSnackbar()}\n      <mwc-card style=\"width: auto; flex: 1;\">\n        <div class=\"column\" style=\"padding: 16px;\">\n          <span class=\"title\" style=\"margin-bottom: 16px;\">Publish Zome</span>\n          <mwc-textfield\n            id=\"zome-name\"\n            label=\"Zome Name\"\n            required\n            @input=${() => this.requestUpdate()}\n            style=\"margin-bottom: 24px;\"\n          ></mwc-textfield>\n\n          <span style=\"margin-bottom: 8px;\">Zome Wasm File (required)</span>\n          <upload-files\n            one-file\n            accepted-files=\".wasm\"\n            @file-uploaded=${(e: CustomEvent) =>\n              (this._zomeWasmHash = e.detail.hash)}\n          ></upload-files>\n          <span style=\"margin-bottom: 8px; margin-top: 24px;\"\n            >UI Bundle File (optional)</span\n          >\n          <upload-files\n            one-file\n            accepted-files=\".js\"\n            @file-uploaded=${(e: CustomEvent) =>\n              this.setUIBundleHash(e.detail.file, e.detail.hash)}\n          ></upload-files>\n\n          <mwc-button\n            style=\"margin-top: 24px;\"\n            label=\"PUBLISH\"\n            raised\n            @click=${() => this.publishZome()}\n            .disabled=${this.publishDisabled}\n          ></mwc-button>\n        </div>\n      </mwc-card>\n    `;\n  }\n\n  static elementDefinitions = {\n    'mwc-textfield': TextField,\n    'mwc-button': Button,\n    'mwc-card': Card,\n    'mwc-snackbar': Snackbar,\n    'upload-files': UploadFiles,\n  };\n\n  static get styles() {\n    return sharedStyles;\n  }\n}\n"]}